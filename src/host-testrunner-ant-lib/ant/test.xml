<?xml version="1.0" encoding="UTF-8"?>
<project name="tester" default="default" basedir="..">
    
	<property file="../../local.properties" />
	<fail unless="sdk.dir" message="Property sdk.dir is not specified." />
	
	<path id="testmanager.classpath">
        <fileset dir="${sdk.dir}/tools/lib" includes="*.jar" />
		<pathelement path="bin" />
		<pathelement path="../host-testrunner-lib/bin" />
    </path>
	
    <classloader name="testmanager.loader" classpathref="testmanager.classpath" />
	
	<taskdef name="rbm-setup" loaderref="testmanager.loader"
	         classname="com.robomorphine.test.ant.SetupTask"
	         classpathref="testmanager.classpath" />
	
	<taskdef name="rbm-avd-config" loaderref="testmanager.loader"
	                 classname="com.robomorphine.test.ant.avd.AvdConfigTask"
	                 classpathref="testmanager.classpath" />
	
	<taskdef name="rbm-create-avd" loaderref="testmanager.loader"
	             classname="com.robomorphine.test.ant.avd.CreateAvdTask"
	             classpathref="testmanager.classpath" />
	

    <taskdef name="rbm-delete-avd" loaderref="testmanager.loader"
                 classname="com.robomorphine.test.ant.avd.DeleteAvdTask"
                 classpathref="testmanager.classpath" />
	
	<taskdef name="rbm-start-emulator" loaderref="testmanager.loader"
                 classname="com.robomorphine.test.ant.emulator.StartEmulatorTask"
                 classpathref="testmanager.classpath" />
	
	<taskdef name="rbm-stop-emulator" loaderref="testmanager.loader"
                 classname="com.robomorphine.test.ant.emulator.StopEmulatorTask"
                 classpathref="testmanager.classpath" />
	
	<taskdef name="rbm-stop-all-emulators" loaderref="testmanager.loader"
                  classname="com.robomorphine.test.ant.emulator.StopEmulatorsTask"
                  classpathref="testmanager.classpath" />
	
	<taskdef name="rbm-lock-device" loaderref="testmanager.loader"
                  classname="com.robomorphine.test.ant.device.LockDeviceTask"
                  classpathref="testmanager.classpath" />
	
	<taskdef name="rbm-unlock-device" loaderref="testmanager.loader"
                  classname="com.robomorphine.test.ant.device.UnlockDeviceTask"
                  classpathref="testmanager.classpath" />
	
	<taskdef name="rbm-get-locked-device" loaderref="testmanager.loader"
	              classname="com.robomorphine.test.ant.device.GetLockedDeviceTask"
	              classpathref="testmanager.classpath" />
	
	<taskdef name="rbm-get-device-property" loaderref="testmanager.loader"
              classname="com.robomorphine.test.ant.device.GetDevicePropertyTask"
              classpathref="testmanager.classpath" />
	
	<taskdef name="rbm-get-apk-package" loaderref="testmanager.loader"
              classname="com.robomorphine.test.ant.device.GetApkPackageTask"
              classpathref="testmanager.classpath" />
	
	<taskdef name="rbm-install-apk" loaderref="testmanager.loader"
              classname="com.robomorphine.test.ant.device.InstallApkTask"
              classpathref="testmanager.classpath" />
	
	<taskdef name="rbm-uninstall-apk" loaderref="testmanager.loader"
                  classname="com.robomorphine.test.ant.device.UninstallApkTask"
                  classpathref="testmanager.classpath" />
	
	<taskdef name="rbm-adb-push" loaderref="testmanager.loader"
                  classname="com.robomorphine.test.ant.device.AdbPushTask"
                  classpathref="testmanager.classpath" />
	
	<taskdef name="rbm-adb-pull" loaderref="testmanager.loader"
                  classname="com.robomorphine.test.ant.device.AdbPullTask"
                  classpathref="testmanager.classpath" />
	
	<taskdef name="rbm-adb-shell" loaderref="testmanager.loader"
                  classname="com.robomorphine.test.ant.device.AdbShellTask"
                  classpathref="testmanager.classpath" />
	
	<taskdef name="rbm-run-tests" loaderref="testmanager.loader"
                  classname="com.robomorphine.test.ant.device.runner.RunTestsTask"
                  classpathref="testmanager.classpath" />
	
	<target name="default" >
		<rbm-setup sdkdir="${sdk.dir}" />
		<rbm-lock-device device="true" />
		<rbm-get-device-property local="local.prop" remote="ro.runtime.firstboot" />
		<rbm-adb-shell log="false" outputproperty="local.prop2" 
			           exitCodeFail="true" exitCodeProperty="exitCode"
			           exitCodeExpected="127" >
			<arg value="ls2" />
			<arg value="-lsa" />
			<arg value="sys/*" />
	    </rbm-adb-shell>
		<echo>${exitCode}</echo>
		<echo>${local.prop2}</echo>
		<rbm-adb-shell cmd="echo test > /sdcard/file" />
		<rbm-adb-pull remote="/sdcard/file" local="file" />
		<rbm-adb-shell cmd="rm /sdcard/file" />
		<rbm-adb-push remote="/sdcard/file" local="file" />
		<rbm-adb-shell cmd="cat /sdcard/file" />
	</target>
	
	<target name="default-device" >
	    <rbm-setup sdkdir="${sdk.dir}" />
	    
		<property name="tester.apk" location="../../bin/debug/tester.app.apk" />
		<property name="tested.apk" location="../../bin/debug/tested.app.apk" />
			
		<rbm-get-apk-package file="${tested.apk}" property="tested.package" />
		<rbm-get-apk-package file="${tester.apk}" property="tester.package" />
		<echo>${tested.package}</echo>
		<echo>${tester.package}</echo>
		
		<rbm-lock-device device="false" />
		<rbm-get-locked-device property="device.serial" />
		<!--rbm-install-apk file="${tested.apk}"/>
		<rbm-install-apk file="${tester.apk}"/-->
		<echo>${device.serial}</echo>
		
		<fileset dir="../../bin/debug/" id="apks" >
			<include name="*.apk"/>
		</fileset>
		
		<rbm-run-tests package="${tester.package}" uninstall="false">
			<junit dir="bin" multiple="true" />
			<apks>
				<tester file="${tester.apk}" />
				<apk file="${tested.apk}" />
				<apk file="${tested.apk}" />
			    <apk file="${tested.apk}" />
				<fileset refid="apks" />
			</apks>
			<args>
			  <coverage enable="false" />
			  <logonly enable="true" />
			  <debug enable="false" />
			  <class name="com.robomorphine.tester.ExampleTestA">
			  	<name name="com.robomorphine.tester.MainActivityTest" />
			  </class>
			</args>
		</rbm-run-tests>
		
		<!--rbm-uninstall-apk package="${tested.package}" />
		<rbm-uninstall-apk file="${tester.apk}" /-->
		
		<rbm-unlock-device />
		<rbm-get-locked-device property="device.serial" />
	</target>
	
	<target name="default-create-and-start">
		<rbm-setup sdkdir="${sdk.dir}" />
	    
		<rbm-avd-config id="avd15" target="Google Inc.:Google APIs:15">
            <abi type="armeabi-v7a" />
            <snapshot enable="true" />
            <sdcard size="10" />            
	        <screen resolution="QVGA" density="hdpi" />
            <hardware>
                <ram size="1024" />
                <heap size="32" />
                <arg key="a" value="c" />
            </hardware>
	    </rbm-avd-config>
		
    	<rbm-create-avd name="test-avd-name" target="Google Inc.:Google APIs:15" force="true">
    		<abi type="armeabi-v7a" />
    		<snapshot enable="true" />
    		<sdcard size="10" />    		
    		<screen resolution="xlarge" density="hdpi" />
    		<hardware>
    			<ram size="1024" />
    			<heap size="64" />
    			<arg key="a" value="b" />
    		</hardware>
    	</rbm-create-avd>				
		<rbm-create-avd name="test-avd15" avdconfig="avd15" force="true"/>
		
		<rbm-stop-all-emulators />
		<rbm-start-emulator avd="test-avd15" serialProperty="emulator-serial" >
			<arg value="-no-audio" />
		</rbm-start-emulator>
		
		<rbm-stop-emulator serial="${emulator-serial}" />
		<rbm-delete-avd name="test-avd15" />
    </target>
</project>
